<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GeeClock</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              mono: ['Roboto Mono', 'monospace'],
            },
            colors: {
              'primary': 'rgb(var(--color-primary) / <alpha-value>)',
              'secondary': 'rgb(var(--color-secondary) / <alpha-value>)',
              'background': 'rgb(var(--color-background) / <alpha-value>)',
              'surface': 'rgb(var(--color-surface) / <alpha-value>)',
              'text-primary': 'rgb(var(--color-text-primary) / <alpha-value>)',
              'text-secondary': 'rgb(var(--color-text-secondary) / <alpha-value>)',
            },
            keyframes: {
              'fade-in': {
                '0%': { opacity: '0', transform: 'translateY(10px) scale(0.98)' },
                '100%': { opacity: '1', transform: 'translateY(0) scale(1)' },
              },
               'slide-in': {
                '0%': { transform: 'translateY(100%)' },
                '100%': { transform: 'translateY(0)' },
              }
            },
            animation: {
              'fade-in': 'fade-in 0.3s ease-out forwards',
              'slide-in': 'slide-in 0.3s ease-out forwards',
            }
          }
        }
      }
    </script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>
    <script type="module">
        import { GoogleGenAI } from 'https://esm.run/@google/genai';
        window.GoogleGenAI = GoogleGenAI;
    </script>
  </head>
  <body class="bg-background text-text-primary font-sans transition-colors duration-300">
    <div id="root"></div>
    <script type="text/babel">

      const { useState, useEffect, useRef, useCallback, Fragment } = React;

      // --- CONSTANTS ---
      const themes = {
          default: { dark: { primary: '79 70 229', secondary: '16 185 129', background: '17 24 39', surface: '31 41 55', 'text-primary': '249 250 251', 'text-secondary': '156 163 175', }, light: { primary: '79 70 229', secondary: '16 185 129', background: '243 244 246', surface: '255 255 255', 'text-primary': '17 24 39', 'text-secondary': '55 65 81', } },
          ocean: { dark: { primary: '59 130 246', secondary: '52 211 153', background: '15 23 42', surface: '30 41 59', 'text-primary': '241 245 249', 'text-secondary': '148 163 184', }, light: { primary: '59 130 246', secondary: '22 163 74', background: '240 249 255', surface: '255 255 255', 'text-primary': '30 41 59', 'text-secondary': '71 85 105', } },
          sunset: { dark: { primary: '249 115 22', secondary: '239 68 68', background: '28 25 23', surface: '41 37 36', 'text-primary': '250 250 249', 'text-secondary': '168 162 158', }, light: { primary: '234 88 12', secondary: '220 38 38', background: '254 252 251', surface: '255 255 255', 'text-primary': '28 25 23', 'text-secondary': '68 64 60', } },
          forest: { dark: { primary: '34 197 94', secondary: '202 138 4', background: '20 30 20', surface: '30 46 30', 'text-primary': '220 252 231', 'text-secondary': '163 230 170', }, light: { primary: '22 163 74', secondary: '202 138 4', background: '240 253 244', surface: '255 255 255', 'text-primary': '21 21 21', 'text-secondary': '63 63 63', } },
          graphite: { dark: { primary: '148 163 184', secondary: '100 116 139', background: '15 23 42', surface: '30 41 59', 'text-primary': '241 245 249', 'text-secondary': '148 163 184', }, light: { primary: '71 85 105', secondary: '100 116 139', background: '241 245 249', surface: '255 255 255', 'text-primary': '15 23 42', 'text-secondary': '51 65 85', } },
          rose: { dark: { primary: '251 113 133', secondary: '251 146 60', background: '53 23 29', surface: '79 32 43', 'text-primary': '255 241 242', 'text-secondary': '253 164 175', }, light: { primary: '244 63 94', secondary: '217 119 6', background: '255 241 242', surface: '255 255 255', 'text-primary': '131 24 67', 'text-secondary': '190 24 93', } }
      };
      const ALARM_SOUNDS = {
          default: { name: 'Alarm Clock', url: 'https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg' },
          digital: { name: 'Digital', url: 'https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg' },
          bell: { name: 'School Bell', url: 'https://actions.google.com/sounds/v1/alarms/school_bell.ogg' },
          rooster: { name: 'Rooster', url: 'https://actions.google.com/sounds/v1/animals/rooster_crowing.ogg' },
      };
      const INITIAL_SETTINGS = { theme: 'default', darkMode: true, useSearch: false, apiKey: '', aiUnlocked: false, alarmSound: 'default', customAlarmSoundUrl: '', showDateTimeInHeader: true };

      // --- ICONS ---
      const Icon = ({ name, className }) => {
        const icons = {
            clock: <path strokeLinecap="round" strokeLinejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />,
            timer: <path strokeLinecap="round" strokeLinejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />,
            plus: <path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" />,
            cog: <path strokeLinecap="round" strokeLinejoin="round" d="M9.594 3.94c.09-.542.56-1.007 1.11-.962l5.123.48c.55.052.994.546.942 1.096l-.48 5.123c-.044.472-.47.84-1.096.942l-5.123-.48c-.55-.052-.994-.546-.942-1.096L9.594 3.94zM15 12a3 3 0 11-6 0 3 3 0 016 0z" />,
            chat: <path strokeLinecap="round" strokeLinejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m3.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />,
            x: <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />,
            play: <path strokeLinecap="round" strokeLinejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.985V5.653z" />,
            pause: <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 5.25v13.5m-6-13.5v13.5" />,
            trash: <path strokeLinecap="round" strokeLinejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.226 2.077H8.062a2.25 2.25 0 01-2.226-2.077L3.882 5.79m18.12-1.02A1.125 1.125 0 0020.25 5.25h-4.5M12 5.25V3m-4.5 2.25H3.75m0 0A1.125 1.125 0 012.625 4.125h18.75c.621 0 1.125.504 1.125 1.125v0" />,
            send: <path strokeLinecap="round" strokeLinejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />,
            reset: <path strokeLinecap="round" strokeLinejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.667 0l3.181-3.183m-4.991-2.691L7.98 12.54M16.023 9.348L12.057 5l-4.066 4.067" />,
        };
        return <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>{icons[name]}</svg>;
      };

      // --- HOOKS ---
      const useLocalStorage = (key, initialValue) => {
        const [storedValue, setStoredValue] = useState(() => {
          try {
            const item = window.localStorage.getItem(key);
            return item ? JSON.parse(item) : initialValue;
          } catch (error) {
            console.error(error);
            return initialValue;
          }
        });

        const setValue = (value) => {
          try {
            const valueToStore = value instanceof Function ? value(storedValue) : value;
            setStoredValue(valueToStore);
            window.localStorage.setItem(key, JSON.stringify(valueToStore));
          } catch (error) {
            console.error(error);
          }
        };
        return [storedValue, setValue];
      };
      
      const useInterval = (callback, delay) => {
        const savedCallback = useRef();
        useEffect(() => { savedCallback.current = callback; }, [callback]);
        useEffect(() => {
          function tick() { savedCallback.current(); }
          if (delay !== null) {
            let id = setInterval(tick, delay);
            return () => clearInterval(id);
          }
        }, [delay]);
      };
      
      // --- COMPONENTS ---
      
      const HeaderClock = () => {
        const [time, setTime] = useState(new Date());
        useEffect(() => {
            const timerId = setInterval(() => setTime(new Date()), 1000);
            return () => clearInterval(timerId);
        }, []);

        return (
            <div className="text-right hidden sm:block">
                <div className="font-mono text-lg font-semibold text-text-primary tracking-tight">
                    {time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false })}
                </div>
                <div className="text-xs text-text-secondary">
                    {time.toLocaleDateString([], { weekday: 'short', month: 'short', day: 'numeric' })}
                </div>
            </div>
        );
      };

      const Header = ({ onSettingsClick, onChatClick, hasApiKey, showDateTime }) => {
        return (
          <header className="flex justify-between items-center p-4 md:p-6 animate-fade-in">
            <h1 className="text-2xl font-bold tracking-tighter text-text-primary">GeeClock</h1>
            <div className="flex items-center gap-4">
              {showDateTime && <HeaderClock />}
              <div className="flex items-center gap-2">
                {hasApiKey && <button onClick={onChatClick} className="p-2 rounded-full hover:bg-surface transition-colors" aria-label="Open Chat"><Icon name="chat" className="w-6 h-6" /></button>}
                <button onClick={onSettingsClick} className="p-2 rounded-full hover:bg-surface transition-colors" aria-label="Open Settings"><Icon name="cog" className="w-6 h-6" /></button>
              </div>
            </div>
          </header>
        );
      };

      const Clock = () => {
        const [time, setTime] = useState(new Date());
        useEffect(() => {
            const timerId = setInterval(() => setTime(new Date()), 1000);
            return () => clearInterval(timerId);
        }, []);

        return (
            <div className="flex flex-col items-center justify-center p-8 animate-fade-in">
                <div className="font-mono text-6xl md:text-8xl lg:text-9xl font-bold tracking-tighter text-primary">
                    {time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false })}
                </div>
                <div className="mt-2 text-lg md:text-xl text-text-secondary">
                    {time.toLocaleDateString([], { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                </div>
            </div>
        );
      };
      
      const formatTime = (seconds) => {
        const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
        const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
        const s = (seconds % 60).toString().padStart(2, '0');
        return `${h}:${m}:${s}`;
      };

      const Timer = ({ timer, onDelete, onToggle, onReset, alarmSoundUrl }) => {
          const [remaining, setRemaining] = useState(timer.remaining);
          const audioRef = useRef();

          useEffect(() => {
              setRemaining(timer.remaining);
          }, [timer.remaining]);

          useInterval(() => {
              if (timer.isRunning && remaining > 0) {
                  const newRemaining = timer.remaining - (Date.now() - timer.startTime) / 1000;
                  setRemaining(Math.max(0, newRemaining));
              }

              if (remaining <= 0 && timer.isRunning) {
                  if (audioRef.current) audioRef.current.play();
                  onToggle(timer.id);
              }
          }, 1000);
          
          const progress = ((timer.duration - remaining) / timer.duration) * 100;

          return (
             <div className="bg-surface rounded-lg p-4 flex flex-col gap-4 relative overflow-hidden animate-fade-in">
                <div className="absolute top-0 left-0 h-full bg-primary/10" style={{ width: `${progress}%`, transition: 'width 1s linear' }} />
                
                <div className="relative z-10 flex justify-between items-center">
                    <span className="font-semibold text-text-primary">{timer.label}</span>
                    <div className="flex items-center">
                      <button onClick={() => onToggle(timer.id)} className="p-2 rounded-full hover:bg-text-secondary/20 transition-colors" aria-label={timer.isRunning ? 'Pause timer' : 'Start timer'}>
                          <Icon name={timer.isRunning ? 'pause' : 'play'} className="w-5 h-5 text-primary" />
                      </button>
                      <button onClick={() => onReset(timer.id)} className="p-2 rounded-full hover:bg-text-secondary/10 text-text-secondary transition-colors" aria-label="Reset timer">
                          <Icon name="reset" className="w-5 h-5" />
                      </button>
                      <button onClick={() => onDelete(timer.id)} className="p-2 rounded-full hover:bg-text-secondary/10 text-text-secondary transition-colors" aria-label="Delete timer">
                          <Icon name="trash" className="w-5 h-5" />
                      </button>
                    </div>
                </div>

                <div className="relative z-10 text-center py-4">
                     <span className="font-mono text-6xl font-bold text-primary tracking-tight">{formatTime(Math.max(0, Math.round(remaining)))}</span>
                </div>
                
                <audio ref={audioRef} src={alarmSoundUrl} preload="auto" />
            </div>
          );
      };
      
      const TimerList = ({ timers, onAdd, onDelete, onToggle, onReset, alarmSoundUrl }) => {
          return (
              <div className="p-4 md:p-6 space-y-4 animate-fade-in">
                  {timers.length === 0 ? (
                      <div className="text-center py-16 text-text-secondary">
                          <p>No timers yet.</p>
                          <button onClick={onAdd} className="mt-4 inline-flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg font-semibold hover:opacity-90 transition-opacity">
                              <Icon name="plus" className="w-5 h-5" />
                              Add Timer
                          </button>
                      </div>
                  ) : (
                      timers.map(timer => (
                          <Timer key={timer.id} timer={timer} onDelete={onDelete} onToggle={onToggle} onReset={onReset} alarmSoundUrl={alarmSoundUrl} />
                      ))
                  )}
              </div>
          );
      };
      
      const Modal = ({ isOpen, onClose, title, children, onTitleClick }) => {
        if (!isOpen) return null;

        return (
          <div className="fixed inset-0 bg-background/80 backdrop-blur-sm flex items-center justify-center z-50 animate-fade-in" onClick={onClose} role="dialog" aria-modal="true" aria-labelledby="modal-title">
            <div className="bg-surface rounded-xl shadow-lg w-full max-w-md m-4 animate-slide-in" onClick={e => e.stopPropagation()}>
              <header className="flex justify-between items-center p-4 border-b border-white/10">
                <h2 id="modal-title" className="text-lg font-semibold" onClick={onTitleClick} style={{ cursor: onTitleClick ? 'pointer' : 'default' }}>{title}</h2>
                <button onClick={onClose} className="p-1 rounded-full hover:bg-white/10" aria-label="Close modal"><Icon name="x" className="w-5 h-5" /></button>
              </header>
              <main className="p-4">
                {children}
              </main>
            </div>
          </div>
        );
      };
      
      const AddTimerModal = ({ isOpen, onClose, onAddTimer }) => {
          const [label, setLabel] = useState('');
          const [hours, setHours] = useState(0);
          const [minutes, setMinutes] = useState(5);
          const [seconds, setSeconds] = useState(0);

          const handleSubmit = (e) => {
              e.preventDefault();
              const duration = (hours * 3600) + (minutes * 60) + seconds;
              if (duration > 0) {
                  onAddTimer({ label: label || 'New Timer', duration });
                  setLabel('');
                  setHours(0);
                  setMinutes(5);
                  setSeconds(0);
                  onClose();
              }
          };
          
          return (
              <Modal isOpen={isOpen} onClose={onClose} title="Add New Timer">
                  <form onSubmit={handleSubmit} className="space-y-4">
                      <div>
                          <label htmlFor="label" className="block text-sm font-medium text-text-secondary">Label</label>
                          <input type="text" id="label" value={label} onChange={e => setLabel(e.target.value)} placeholder="e.g., Cooking Pasta" className="mt-1 w-full p-2 rounded-md bg-background border border-surface focus:ring-2 focus:ring-primary outline-none" />
                      </div>
                      <div className="flex gap-2">
                          <div className="flex-1">
                              <label htmlFor="hours" className="block text-sm font-medium text-text-secondary">Hours</label>
                              <input type="number" id="hours" value={hours} onChange={e => setHours(parseInt(e.target.value, 10))} min="0" max="23" className="mt-1 w-full p-2 rounded-md bg-background border border-surface focus:ring-2 focus:ring-primary outline-none" />
                          </div>
                          <div className="flex-1">
                              <label htmlFor="minutes" className="block text-sm font-medium text-text-secondary">Minutes</label>
                              <input type="number" id="minutes" value={minutes} onChange={e => setMinutes(parseInt(e.target.value, 10))} min="0" max="59" className="mt-1 w-full p-2 rounded-md bg-background border border-surface focus:ring-2 focus:ring-primary outline-none" />
                          </div>
                          <div className="flex-1">
                              <label htmlFor="seconds" className="block text-sm font-medium text-text-secondary">Seconds</label>
                              <input type="number" id="seconds" value={seconds} onChange={e => setSeconds(parseInt(e.target.value, 10))} min="0" max="59" className="mt-1 w-full p-2 rounded-md bg-background border border-surface focus:ring-2 focus:ring-primary outline-none" />
                          </div>
                      </div>
                      <button type="submit" className="w-full p-2 bg-primary text-white font-semibold rounded-md hover:opacity-90 transition-opacity">Add Timer</button>
                  </form>
              </Modal>
          );
      };
      
      const SettingsModal = ({ isOpen, onClose, settings, onSettingsChange }) => {
        const [titleClickCount, setTitleClickCount] = useState(0);

        const handleTitleClick = () => {
          if (settings.aiUnlocked) return;
          const newCount = titleClickCount + 1;
          setTitleClickCount(newCount);
          if (newCount >= 5) {
            onSettingsChange({ ...settings, aiUnlocked: true });
          }
        };

        return (
          <Modal isOpen={isOpen} onClose={onClose} title="Settings" onTitleClick={handleTitleClick}>
            <div className="space-y-6">
              <div>
                <label className="block text-sm font-medium text-text-secondary">Theme</label>
                <div className="grid grid-cols-3 gap-2 mt-2">
                  {Object.keys(themes).map(themeKey => (
                    <button key={themeKey} onClick={() => onSettingsChange({...settings, theme: themeKey })} className={`p-2 rounded-md text-sm capitalize border-2 ${settings.theme === themeKey ? 'border-primary' : 'border-surface'}`}>
                      {themeKey}
                    </button>
                  ))}
                </div>
              </div>
              <div>
                <label className="block text-sm font-medium text-text-secondary">Appearance</label>
                <div className="mt-2 flex rounded-md bg-background p-1">
                    <button onClick={() => onSettingsChange({...settings, darkMode: false})} className={`flex-1 p-1.5 rounded text-sm ${!settings.darkMode ? 'bg-surface shadow' : ''}`}>Light</button>
                    <button onClick={() => onSettingsChange({...settings, darkMode: true})} className={`flex-1 p-1.5 rounded text-sm ${settings.darkMode ? 'bg-surface shadow' : ''}`}>Dark</button>
                </div>
              </div>
               <div className="flex items-center justify-between">
                  <label htmlFor="show-datetime" className="text-sm font-medium text-text-secondary">
                      Show Time in Header
                      <p className="text-xs text-text-secondary/70">Display time and date in the header.</p>
                  </label>
                  <button
                      id="show-datetime"
                      role="switch"
                      aria-checked={settings.showDateTimeInHeader}
                      onClick={() => onSettingsChange({...settings, showDateTimeInHeader: !settings.showDateTimeInHeader})}
                      className={`relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-surface ${settings.showDateTimeInHeader ? 'bg-primary' : 'bg-gray-600'}`}
                  >
                      <span className={`inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out ${settings.showDateTimeInHeader ? 'translate-x-5' : 'translate-x-0'}`} />
                  </button>
              </div>
               <div>
                <label className="block text-sm font-medium text-text-secondary">Alarm Sound</label>
                <select
                  value={settings.alarmSound}
                  onChange={e => onSettingsChange({ ...settings, alarmSound: e.target.value, customAlarmSoundUrl: e.target.value === 'custom' ? settings.customAlarmSoundUrl : '' })}
                  className="mt-1 w-full p-2 rounded-md bg-background border border-surface focus:ring-2 focus:ring-primary outline-none"
                  aria-label="Select alarm sound"
                >
                  {Object.entries(ALARM_SOUNDS).map(([key, { name }]) => (
                    <option key={key} value={key}>{name}</option>
                  ))}
                  <option value="custom">Custom URL</option>
                </select>
              </div>
              {settings.alarmSound === 'custom' && (
                <div className="animate-fade-in">
                  <label htmlFor="custom-alarm-url" className="block text-sm font-medium text-text-secondary">Custom Sound URL</label>
                  <input
                    type="url"
                    id="custom-alarm-url"
                    value={settings.customAlarmSoundUrl}
                    onChange={e => onSettingsChange({ ...settings, customAlarmSoundUrl: e.target.value })}
                    placeholder="https://example.com/sound.mp3"
                    className="mt-1 w-full p-2 rounded-md bg-background border border-surface focus:ring-2 focus:ring-primary outline-none"
                  />
                </div>
              )}

              {settings.aiUnlocked && (
                <div className="pt-4 mt-4 border-t border-surface">
                  <h3 className="text-md font-semibold text-text-primary">AI Assistant</h3>
                   <p className="text-xs text-text-secondary/70 mb-4">Click the modal title 5 times to hide this section.</p>
                  
                  <div>
                    <label htmlFor="api-key" className="block text-sm font-medium text-text-secondary">Gemini API Key</label>
                    <input 
                      type="password"
                      id="api-key"
                      value={settings.apiKey}
                      onChange={e => onSettingsChange({...settings, apiKey: e.target.value})}
                      placeholder="Enter your Gemini API Key"
                      className="mt-1 w-full p-2 rounded-md bg-background border border-surface focus:ring-2 focus:ring-primary outline-none"
                    />
                     <p className="text-xs text-text-secondary/70 mt-1">Your key is stored locally in your browser.</p>
                  </div>

                  <div className={`mt-4 flex items-center justify-between transition-opacity ${settings.apiKey ? 'opacity-100' : 'opacity-50'}`}>
                      <label htmlFor="use-search" className="text-sm font-medium text-text-secondary">
                          Enable Google Search
                          <p className="text-xs text-text-secondary/70">Allow AI to access up-to-date information.</p>
                      </label>
                      <button
                          id="use-search"
                          role="switch"
                          aria-checked={settings.useSearch}
                          onClick={() => settings.apiKey && onSettingsChange({...settings, useSearch: !settings.useSearch})}
                          disabled={!settings.apiKey}
                          className={`relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-surface ${settings.useSearch ? 'bg-primary' : 'bg-gray-600'} ${!settings.apiKey ? 'cursor-not-allowed' : ''}`}
                      >
                          <span className={`inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out ${settings.useSearch ? 'translate-x-5' : 'translate-x-0'}`} />
                      </button>
                  </div>
                </div>
              )}
            </div>
          </Modal>
        );
      };
      
      const ChatBot = ({ isOpen, onClose, useSearch, apiKey }) => {
          const [messages, setMessages] = useState([]);
          const [input, setInput] = useState('');
          const [isLoading, setIsLoading] = useState(false);
          const messagesEndRef = useRef(null);
          const chatRef = useRef(null);
          const lastSettings = useRef({});
          
          useEffect(() => {
            if (isOpen) {
              if (!apiKey) {
                setMessages([{ role: 'model', text: 'Welcome! Please set your Gemini API Key in the Settings to enable the AI assistant.' }]);
                chatRef.current = null;
                return;
              }

              const currentSettings = { apiKey, useSearch };
              if (
                !chatRef.current ||
                lastSettings.current.apiKey !== currentSettings.apiKey ||
                lastSettings.current.useSearch !== currentSettings.useSearch
              ) {
                console.log("Initializing new chat session.");
                try {
                  const ai = new window.GoogleGenAI({ apiKey });
                  chatRef.current = ai.chats.create({
                    model: 'gemini-2.5-flash',
                    config: {
                      systemInstruction: "You are GeeClock, a helpful AI assistant integrated into a timer and clock app. Be concise and helpful.",
                      tools: useSearch ? [{googleSearch: {}}] : undefined,
                    },
                  });
                  lastSettings.current = currentSettings;
                  setMessages([{ role: 'model', text: 'Hello! How can I help you today?' }]);
                } catch (error) {
                    console.error("AI Initialization failed:", error);
                    setMessages([{ role: 'model', text: 'Failed to initialize AI. Please check your API key.' }]);
                    chatRef.current = null;
                }
              }
            }
          }, [isOpen, apiKey, useSearch]);
          
          const scrollToBottom = () => {
              messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
          };
          
          useEffect(scrollToBottom, [messages]);
          
          const handleSend = async () => {
              if (!input.trim() || isLoading || !chatRef.current) return;

              const newMessages = [...messages, { role: 'user', text: input }];
              setMessages(newMessages);
              const userInput = input;
              setInput('');
              setIsLoading(true);

              try {
                  const result = await chatRef.current.sendMessage({ message: userInput });
                  setMessages(prev => [...prev, { role: 'model', text: result.text }]);
              } catch (error) {
                  console.error("Error sending message:", error);
                  setMessages(prev => [...prev, { role: 'model', text: 'Sorry, I encountered an error. Check your API key or the console.' }]);
              } finally {
                  setIsLoading(false);
              }
          };

          return (
              <Modal isOpen={isOpen} onClose={onClose} title="GeeClock AI Assistant">
                  <div className="flex flex-col h-[60vh]">
                      <div className="flex-1 overflow-y-auto space-y-4 p-2">
                          {messages.map((msg, index) => (
                              <div key={index} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                  <div className={`max-w-xs md:max-w-md p-3 rounded-lg ${msg.role === 'user' ? 'bg-primary text-white' : 'bg-background'}`}>
                                      {msg.text}
                                  </div>
                              </div>
                          ))}
                          {isLoading && (
                            <div className="flex justify-start">
                                <div className="p-3 rounded-lg bg-background">
                                    <div className="flex items-center gap-2">
                                        <span className="h-2 w-2 bg-primary rounded-full animate-bounce [animation-delay:-0.3s]"></span>
                                        <span className="h-2 w-2 bg-primary rounded-full animate-bounce [animation-delay:-0.15s]"></span>
                                        <span className="h-2 w-2 bg-primary rounded-full animate-bounce"></span>
                                    </div>
                                </div>
                            </div>
                          )}
                          <div ref={messagesEndRef} />
                      </div>
                      <div className="mt-4 flex gap-2">
                          <input 
                            type="text" 
                            value={input}
                            onChange={e => setInput(e.target.value)}
                            onKeyPress={e => e.key === 'Enter' && handleSend()}
                            placeholder="Ask anything..."
                            className="flex-1 p-2 rounded-md bg-background border border-surface focus:ring-2 focus:ring-primary outline-none"
                            disabled={isLoading || !chatRef.current}
                          />
                          <button onClick={handleSend} disabled={isLoading || !input.trim() || !chatRef.current} className="p-2 bg-primary text-white rounded-md hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed transition-opacity">
                            <Icon name="send" className="w-5 h-5"/>
                          </button>
                      </div>
                  </div>
              </Modal>
          );
      };

      // --- APP ---
      const App = () => {
        const [settings, setSettings] = useLocalStorage('geeclock-settings', INITIAL_SETTINGS);
        const [timers, setTimers] = useLocalStorage('geeclock-timers', []);
        const [activeTab, setActiveTab] = useState('clock');
        const [isAddTimerModalOpen, setAddTimerModalOpen] = useState(false);
        const [isSettingsModalOpen, setSettingsModalOpen] = useState(false);
        const [isChatOpen, setChatOpen] = useState(false);

        useEffect(() => {
          const root = document.documentElement;
          const theme = themes[settings.theme][settings.darkMode ? 'dark' : 'light'];
          
          Object.entries(theme).forEach(([key, value]) => {
            root.style.setProperty(`--color-${key}`, value);
          });
          
          if (settings.darkMode) {
            root.classList.add('dark');
          } else {
            root.classList.remove('dark');
          }
        }, [settings]);

        const handleAddTimer = ({ label, duration }) => {
          const newTimer = {
            id: Date.now(),
            label,
            duration,
            remaining: duration,
            isRunning: false,
          };
          setTimers(prev => [...prev, newTimer]);
        };

        const handleDeleteTimer = (id) => {
          setTimers(prev => prev.filter(t => t.id !== id));
        };
        
         const handleToggleTimer = (id) => {
          setTimers(timers => timers.map(timer => {
            if (timer.id !== id) return timer;
            
            const isRunning = !timer.isRunning;
            if (isRunning) {
              // Starting or resuming
              const startTime = Date.now() - ((timer.duration - timer.remaining) * 1000);
              return { ...timer, isRunning: true, startTime };
            } else {
              // Pausing
              const elapsed = (Date.now() - timer.startTime) / 1000;
              const remaining = timer.duration - elapsed;
              return { ...timer, isRunning: false, remaining: Math.max(0, remaining) };
            }
          }));
        };

        const handleResetTimer = (id) => {
          setTimers(timers => timers.map(timer => {
            if (timer.id === id) {
              return { ...timer, isRunning: false, remaining: timer.duration };
            }
            return timer;
          }));
        };


        const MainContent = () => {
            switch(activeTab) {
                case 'clock': return <Clock />;
                case 'timers': {
                    const alarmSoundUrl = settings.alarmSound === 'custom'
                        ? settings.customAlarmSoundUrl
                        : (ALARM_SOUNDS[settings.alarmSound]?.url || ALARM_SOUNDS.default.url);
                    return <TimerList timers={timers} onAdd={() => setAddTimerModalOpen(true)} onDelete={handleDeleteTimer} onToggle={handleToggleTimer} onReset={handleResetTimer} alarmSoundUrl={alarmSoundUrl} />;
                }
                default: return <Clock />;
            }
        };

        return (
          <div className="min-h-screen flex flex-col max-w-3xl mx-auto">
            <Header onSettingsClick={() => setSettingsModalOpen(true)} onChatClick={() => setChatOpen(true)} hasApiKey={!!settings.apiKey} showDateTime={settings.showDateTimeInHeader} />
            
            <nav className="flex justify-center p-2">
              <div className="flex items-center gap-2 bg-surface p-1.5 rounded-full animate-fade-in">
                <button onClick={() => setActiveTab('clock')} className={`px-4 py-1.5 text-sm font-semibold rounded-full ${activeTab === 'clock' ? 'bg-primary text-white' : 'hover:bg-background/50'}`}>
                  <Icon name="clock" className="w-5 h-5 inline-block mr-2" />Clock
                </button>
                <button onClick={() => setActiveTab('timers')} className={`px-4 py-1.5 text-sm font-semibold rounded-full ${activeTab === 'timers' ? 'bg-primary text-white' : 'hover:bg-background/50'}`}>
                  <Icon name="timer" className="w-5 h-5 inline-block mr-2" />Timers
                </button>
              </div>
            </nav>

            <main className="flex-1">
              <MainContent />
            </main>
            
            {activeTab === 'timers' && (
                <div className="fixed bottom-6 right-6">
                    <button onClick={() => setAddTimerModalOpen(true)} className="p-4 bg-secondary text-white rounded-full shadow-lg hover:scale-105 transition-transform" aria-label="Add Timer">
                        <Icon name="plus" className="w-7 h-7" />
                    </button>
                </div>
            )}
            
            <AddTimerModal isOpen={isAddTimerModalOpen} onClose={() => setAddTimerModalOpen(false)} onAddTimer={handleAddTimer} />
            <SettingsModal isOpen={isSettingsModalOpen} onClose={() => setSettingsModalOpen(false)} settings={settings} onSettingsChange={setSettings} />
            <ChatBot isOpen={isChatOpen} onClose={() => setChatOpen(false)} useSearch={settings.useSearch} apiKey={settings.apiKey} />
          </div>
        );
      };

      ReactDOM.render(<App />, document.getElementById('root'));

    </script>
  </body>
</html>
